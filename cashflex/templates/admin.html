{% extends 'base.html' %}
{% block content %}

<div class="container mt-3 mb-5">
  <h2 class="text-center text-danger mb-4">Painel Administrativo</h2>

  <!-- Estatísticas -->
  <div class="row text-center mb-4">
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Usuários</h6>
          <h4 class="fw-bold">{{ total_users }}</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Investido</h6>
          <h4 class="fw-bold">{{ total_investido }} AOA</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Retirado</h6>
          <h4 class="fw-bold">{{ total_sacado }} AOA</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Em Circulação</h6>
          <h4 class="fw-bold">{{ saldo_total }} AOA</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Depósitos</h6>
          <h4 class="fw-bold">{{ total_depositos }} AOA</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" data-bs-toggle="tab" href="#users" role="tab">Usuários</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#withdrawals" role="tab">Retiradas</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#investments" role="tab">Investimentos Pendentes</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#plans" role="tab">Planos</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#deposits" role="tab">Depósitos</a>
    </li>
  </ul>

  <div class="tab-content mt-3">

    <!-- Aba: Usuários -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
      <form method="GET" class="mb-3 d-flex" role="search">
        <input type="text" name="search" class="form-control me-2" placeholder="Buscar por telefone" value="{{ request.args.get('search', '') }}">
        <button class="btn btn-outline-primary" type="submit">Buscar</button>
      </form>
      <div class="table-responsive">
        <table class="table table-sm table-bordered">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th><th scope="col">Telefone</th><th scope="col">Saldo</th><th scope="col">Código</th>
              <th scope="col">Banco</th><th scope="col">IBAN</th><th scope="col">Titular</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.phone }}</td>
              <td>{{ u.balance }}</td>
              <td>{{ u.invite_code }}</td>
              <td>{{ u.bank or 'N/A' }}</td>
              <td>{{ u.iban or 'N/A' }}</td>
              <td>{{ u.iban_owner or 'N/A' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center">Nenhum usuário encontrado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Aba: Saques -->
    <div class="tab-pane fade" id="withdrawals" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th><th scope="col">Usuário</th><th scope="col">Valor</th><th scope="col">Status</th>
              <th scope="col">Banco</th><th scope="col">IBAN</th><th scope="col">Titular</th><th scope="col">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for w in withdrawals %}
            <tr>
              <td>{{ w.id }}</td>
              <td>{{ w.user_id }}</td>
              <td>{{ w.amount }} AOA</td>
              <td>{{ w.status }}</td>
              <td>{{ w.user.bank or 'N/A' }}</td>
              <td>{{ w.user.iban or 'N/A' }}</td>
              <td>{{ w.user.iban_owner or 'N/A' }}</td>
              <td>
                {% if w.status == "Pendente" %}
                  <form action="{{ url_for('admin.approve_withdraw', id=w.id) }}" method="post" style="display:inline;">
                    {{ simple_action_form.hidden_tag() }}
                    <button type="submit" class="btn btn-success btn-sm">Aprovar</button>
                  </form>
                  <form action="{{ url_for('admin.reject_withdraw', id=w.id) }}" method="post" style="display:inline;">
                    {{ simple_action_form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger btn-sm">Rejeitar</button>
                  </form>
                {% else %}
                  <span class="text-muted">--</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center">Nenhum saque registrado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Aba: Investimentos Pendentes -->
    <div class="tab-pane fade" id="investments" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th><th scope="col">Usuário</th><th scope="col">Valor</th><th scope="col">Comprovativo</th><th scope="col">Status</th><th scope="col">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for i in investments %}
              {% if i.status == 'Pendente' and i.amount >= 5000 %}
              <tr>
                <td>{{ i.id }}</td>
                <td>{{ i.user_id }}</td>
                <td>{{ i.amount }} AOA</td>
                <td>
                  {% if i.proof %}
                    <a href="{{ url_for('static', filename='proofs/' + i.proof) }}" target="_blank">Ver</a>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>{{ i.status }}</td>
                <td>
                  <form action="{{ url_for('admin.approve_investment', id=i.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-success btn-sm">Aprovar</button>
                  </form>
                  <form action="{{ url_for('admin.reject_investment', id=i.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-sm">Rejeitar</button>
                  </form>
                </td>
              </tr>
              {% endif %}
            {% else %}
            <tr><td colspan="6" class="text-center">Nenhum investimento pendente</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

   <!-- Aba: Depósitos -->
<div class="tab-pane fade" id="deposits" role="tabpanel">
  <h4>Depósitos</h4>
  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Usuário</th>
        <th scope="col">Número</th> <!-- Novo -->
        <th scope="col">Valor</th>
        <th scope="col">Status</th>
        <th scope="col">Data</th>
        <th scope="col">Comprovativo</th>
        <th scope="col">Ação</th>
      </tr>
    </thead>
    <tbody>
      {% for deposito in deposits %}
        <tr class="{% if deposito.status.lower() == 'pendente' %}table-warning{% elif deposito.status.lower() == 'aprovado' %}table-success{% elif deposito.status.lower() == 'recusado' %}table-danger{% endif %}">
          <td>{{ deposito.id }}</td>
          <td>{{ deposito.user.nome }}</td>
          <td>{{ deposito.user.phone }}</td> <!-- Mostra número do usuário -->
          <td>Kz {{ "{:,.2f}".format(deposito.amount) }}</td>
          <td>{{ deposito.status }}</td>
          <td>{{ deposito.timestamp.strftime('%d/%m/%Y %H:%M') }}</td>
          <td>
            {% if deposito.proof %}
              <a href="{{ url_for('static', filename='proofs/' + deposito.proof) }}" 
                 target="_blank" class="btn btn-outline-primary btn-sm">
                Ver Comprovativo
              </a>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if deposito.status.lower() == 'pendente' %}
              <!-- Botão Aprovar -->
              <button type="button" class="btn btn-success btn-sm"
                      onclick="confirmarAcao('aprovar', {{ deposito.id }}, '{{ deposito.user.nome }}', {{ deposito.amount }})">
                Aprovar
              </button>

              <!-- Botão Rejeitar -->
              <button type="button" class="btn btn-danger btn-sm"
                      onclick="confirmarAcao('rejeitar', {{ deposito.id }}, '{{ deposito.user.nome }}', {{ deposito.amount }})">
                Rejeitar
              </button>
            {% else %}
              <span>-</span>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="8" class="text-center">Nenhum depósito registrado</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

    <!-- Aba: Planos -->
    <div class="tab-pane fade" id="plans" role="tabpanel">
      <h5 class="mb-3">Planos Existentes</h5>
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th><th scope="col">Nome</th><th scope="col">Invest</th><th scope="col">Rendimento</th><th scope="col">Retorno</th><th scope="col">Status</th><th scope="col">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for p in planos %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.nome }}</td>
            <td>{{ p.invest }}</td>
            <td>{{ p.rendimento }}</td>
            <td>{{ p.retorno }}</td>
            <td>{{ 'Ativo' if p.ativo else 'Inativo' }}</td>
            <td>
              <a href="{{ url_for('admin.editar_plano', id=p.id) }}" class="btn btn-primary btn-sm">Editar</a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-center">Nenhum plano cadastrado</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmarAcao(acao, id, usuario, valor) {
    let rota = acao === 'aprovar'
      ? "{{ url_for('admin.aprovar_deposito', id=0) }}".replace('0', id)
      : "{{ url_for('admin.recusar_deposito', id=0) }}".replace('0', id);

    Swal.fire({
      title: (acao === 'aprovar' ? 'Aprovar Depósito' : 'Rejeitar Depósito'),
      html: `
        <p><b>ID:</b> ${id}</p>
        <p><b>Usuário:</b> ${usuario}</p>
        <p><b>Valor:</b> Kz ${valor.toFixed(2)}</p>
        <p style="color:${acao === 'aprovar' ? 'green' : 'red'}">
          Tem certeza que deseja ${acao === 'aprovar' ? 'aprovar' : 'rejeitar'} este depósito?
        </p>
      `,
      icon: acao === 'aprovar' ? 'success' : 'warning',
      showCancelButton: true,
      confirmButtonColor: acao === 'aprovar' ? '#198754' : '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: acao === 'aprovar' ? 'Sim, aprovar' : 'Sim, rejeitar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        // Cria formulário dinâmico e envia
        let form = document.createElement('form');
        form.method = 'POST';
        form.action = rota;

        let csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = "{{ simple_action_form.csrf_token._value() }}";
        form.appendChild(csrf);

        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

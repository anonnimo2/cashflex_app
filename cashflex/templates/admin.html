{% extends 'base_auth.html' %}
{% block content %}

<div class="container mt-4 mb-5">
  <h2 class="text-center text-danger fw-bold mb-4">üìä Painel Administrativo</h2>

  <!-- Estat√≠sticas -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="card shadow-lg border-0 text-center bg-light rounded-3 h-100">
        <div class="card-body">
          <h6 class="text-muted">Usu√°rios</h6>
          <h3 class="fw-bold text-primary">{{ total_users }}</h3>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card shadow-lg border-0 text-center bg-light rounded-3 h-100">
        <div class="card-body">
          <h6 class="text-muted">Investido</h6>
          <h3 class="fw-bold text-success">Kz {{ total_investido }}</h3>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card shadow-lg border-0 text-center bg-light rounded-3 h-100">
        <div class="card-body">
          <h6 class="text-muted">Retirado</h6>
          <h3 class="fw-bold text-danger">Kz {{ total_sacado }}</h3>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card shadow-lg border-0 text-center bg-light rounded-3 h-100">
        <div class="card-body">
          <h6 class="text-muted">Em Circula√ß√£o</h6>
          <h3 class="fw-bold text-warning">Kz {{ saldo_total }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-pills justify-content-center mb-3" id="adminTab" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#users">üë§ Usu√°rios</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#withdrawals">üí∏ Retiradas</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#deposits">üè¶ Dep√≥sitos</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#plans">üìã Planos</a></li>
  </ul>

  <!-- Conte√∫do das Abas -->
  <div class="tab-content mt-3">

   
   <!-- Usu√°rios -->
<div class="tab-pane fade show active" id="users">
  <form method="GET" class="mb-3 d-flex">
    <input type="text" name="search" class="form-control me-2" placeholder="Buscar por telefone" value="{{ request.args.get('search', '') }}">
    <button class="btn btn-outline-primary" type="submit">üîç Buscar</button>
  </form>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Telefone</th>
          <th>Saldo</th>
          <th>C√≥digo</th>
          <th>Banco</th>
          <th>IBAN</th>
          <th>Titular</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.id }}</td>
          <td>{{ u.nome }}</td>
          <td>{{ u.phone }}</td>
          <td><span class="badge bg-success">Kz {{ "%.2f"|format(u.balance) }}</span></td>
          <td>{{ u.invite_code }}</td>
          <td>{{ u.bank or 'N/A' }}</td>
          <td>{{ u.iban or 'N/A' }}</td>
          <td>{{ u.iban_owner or 'N/A' }}</td>
          <td>
           
           
   <!-- Bot√£o adicionar VIP -->
<button 
  class="btn btn-sm btn-warning" 
  onclick='confirmarVIP({{ u.id }}, "{{ u.nome | e }}")'>
  <i class="fas fa-star"></i> VIP
</button>

<!-- Bot√£o adicionar saldo -->
<button 
  class="btn btn-sm btn-success"
  onclick='confirmarSaldo({{ u.id }}, "{{ u.nome | e }}")'>
  <i class="fas fa-plus-circle"></i> Saldo
</button>


          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="text-center text-muted">Nenhum usu√°rio encontrado</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

    <!-- Retiradas -->
    <div class="tab-pane fade" id="withdrawals">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th><th>Usu√°rio</th><th>Valor</th><th>Status</th>
              <th>Banco</th><th>IBAN</th><th>Titular</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for w in withdrawals %}
            <tr>
              <td>{{ w.id }}</td>
              <td>{{ w.user_id }}</td>
              <td><span class="badge bg-info">Kz {{ w.amount }}</span></td>
              <td>
                <span class="badge 
                  {% if w.status == 'Pendente' %}bg-warning
                  {% elif w.status == 'Aprovado' %}bg-success
                  {% else %}bg-danger{% endif %}">
                  {{ w.status }}
                </span>
              </td>
              <td>{{ w.user.bank or 'N/A' }}</td>
              <td>{{ w.user.iban or 'N/A' }}</td>
              <td>{{ w.user.iban_owner or 'N/A' }}</td>
              <td>
                {% if w.status == "Pendente" %}
                  <form action="{{ url_for('admin.approve_withdraw', id=w.id) }}" method="post" class="d-inline">
                    {{ simple_action_form.hidden_tag() }}
                    <button type="submit" class="btn btn-success btn-sm">‚úîÔ∏è</button>
                  </form>
                  <form action="{{ url_for('admin.reject_withdraw', id=w.id) }}" method="post" class="d-inline">
                    {{ simple_action_form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger btn-sm">‚ùå</button>
                  </form>
                {% else %}
                  <span class="text-muted">--</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">Nenhum saque registrado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Dep√≥sitos -->
    <div class="tab-pane fade" id="deposits" role="tabpanel">
      <h5 class="mb-3">üì• Dep√≥sitos</h5>
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th><th>Usu√°rio</th><th>N√∫mero</th><th>Valor</th>
              <th>Status</th><th>Data</th><th>Comprovativo</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for deposito in deposits %}
            <tr>
              <td>#{{ deposito.id }}</td>
              <td>{{ deposito.user.nome }}</td>
              <td>{{ deposito.user.phone }}</td>
              <td><span class="text-success fw-semibold">Kz {{ "{:,.2f}".format(deposito.amount) }}</span></td>
              <td>
                {% if deposito.status.lower() == 'pendente' %}
                  <span class="badge bg-warning text-dark">‚è≥ Pendente</span>
                {% elif deposito.status.lower() == 'aprovado' %}
                  <span class="badge bg-success">‚úîÔ∏è Aprovado</span>
                {% elif deposito.status.lower() == 'recusado' %}
                  <span class="badge bg-danger">‚ùå Recusado</span>
                {% else %}
                  <span class="badge bg-secondary">{{ deposito.status }}</span>
                {% endif %}
              </td>
              <td>{{ deposito.timestamp.strftime('%d/%m/%Y %H:%M') }}</td>
              <td>
                {% if deposito.proof %}
                  <a href="{{ url_for('static', filename='proofs/' ~ deposito.proof) }}" target="_blank" class="btn btn-outline-primary btn-sm">
                    üìÑ Ver
                  </a>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if deposito.status.lower() == 'pendente' %}
                  <button type="button" class="btn btn-success btn-sm me-1" 
                          onclick="confirmarDeposito('aprovar', {{ deposito.id }}, '{{ deposito.user.nome }}', {{ deposito.amount|float }})">
                    ‚úîÔ∏è
                  </button>
                  <button type="button" class="btn btn-danger btn-sm" 
                          onclick="confirmarDeposito('rejeitar', {{ deposito.id }}, '{{ deposito.user.nome }}', {{ deposito.amount|float }})">
                    ‚ùå
                  </button>
                {% else %}
                  <span class="badge bg-secondary">Sem a√ß√µes</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">Nenhum dep√≥sito registrado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>


<!-- Aba: Planos -->
<div class="tab-pane fade" id="plans" role="tabpanel">

  <h5 class="mb-3">üìä Planos Existentes</h5>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Investimento</th>
          <th>Rendimento</th>
          <th>Retorno</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for p in planos %}
        <tr>
          <td>{{ p.id }}</td>
          <td><strong>{{ p.nome }}</strong></td>
          <td><span class="badge bg-info">Kz {{ p.invest }}</span></td>
          <td><span class="badge bg-success">+{{ p.rendimento }}%</span></td>
          <td><span class="badge bg-primary">{{ p.retorno }} dias</span></td>
          <td>
            <span class="badge {{ 'bg-success' if p.ativo else 'bg-secondary' }}">
              {{ 'Ativo' if p.ativo else 'Inativo' }}
            </span>
          </td>
          <td>
            <a href="{{ url_for('admin.editar_plano', id=p.id) }}" class="btn btn-primary btn-sm">
              <i class="fas fa-edit"></i> Editar
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">Nenhum plano cadastrado</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // ‚úÖ Aprovar/Rejeitar dep√≥sito
  function confirmarDeposito(acao, id, usuario, valor) {
    let rota = acao === 'aprovar' 
      ? "{{ url_for('admin.aprovar_deposito', id=0) }}".replace("0", id)
      : "{{ url_for('admin.recusar_deposito', id=0) }}".replace("0", id);

    Swal.fire({
      title: (acao === 'aprovar' ? 'Aprovar Dep√≥sito' : 'Rejeitar Dep√≥sito'),
      html: `
        <p><b>ID:</b> ${id}</p>
        <p><b>Usu√°rio:</b> ${usuario}</p>
        <p><b>Valor:</b> Kz ${parseFloat(valor).toFixed(2)}</p>
      `,
      icon: acao === 'aprovar' ? 'success' : 'warning',
      showCancelButton: true,
      confirmButtonColor: acao === 'aprovar' ? '#198754' : '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: acao === 'aprovar' ? 'Sim, aprovar' : 'Sim, rejeitar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        enviarAcao(rota);
      }
    });
  }
</script>

<script>
function confirmarSaldo(userId) {
    Swal.fire({
        title: "Adicionar Saldo",
        text: "Informe o valor para adicionar",
        input: "number",
        inputAttributes: { min: 1 },
        showCancelButton: true,
        confirmButtonText: "Adicionar",
        cancelButtonText: "Cancelar",
        inputValidator: (value) => {
            if (!value || value <= 0) return "‚ùå Informe um valor v√°lido!";
        }
    }).then((result) => {
        if (result.isConfirmed) {
            let valor = parseFloat(result.value);

            fetch("/admin/add_balance", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: userId, valor: valor })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("‚úÖ Sucesso!", data.success, "success")
                        .then(() => location.reload());
                } else {
                    Swal.fire("‚ùå Erro", data.error || "Algo deu errado!", "error");
                }
            })
            .catch(err => {
                Swal.fire("‚ùå Erro", "Falha de conex√£o com o servidor.", "error");
                console.error(err);
            });
        }
    });
}
</script>


<script>
  // ‚úÖ Ativar VIP
  function confirmarVIP(userId, usuario) {
    // Buscar planos dispon√≠veis
    fetch("{{ url_for('admin.planos_vip') }}")
      .then(response => response.json())
      .then(planos => {
        if (!planos.length) {
          Swal.fire("Nenhum plano VIP dispon√≠vel!", "", "error");
          return;
        }

        // montar select
        let options = planos.map(p => 
          `<option value="${p.id}">${p.nome} - Kz ${parseFloat(p.price).toFixed(2)}</option>`
        ).join("");

        Swal.fire({
          title: `Ativar VIP para ${usuario}`,
          html: `
            <label>Escolha um plano:</label>
            <select id="planoSelect" class="form-select">
              ${options}
            </select>
          `,
          showCancelButton: true,
          confirmButtonText: "Ativar",
          cancelButtonText: "Cancelar",
          preConfirm: () => {
            let planoId = document.getElementById("planoSelect").value;
            if (!planoId) {
              Swal.showValidationMessage("Selecione um plano!");
            }
            return planoId;
          }
        }).then((result) => {
          if (result.isConfirmed) {
            let planoId = result.value;

           fetch("{{ url_for('admin.activate_vip') }}", {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded" },
  body: `user_id=${userId}&plano_id=${planoId}`
})
.then(res => res.json())
.then(data => {
  if (data.success) {
    Swal.fire("‚úÖ Sucesso!", data.success, "success")
      .then(() => location.reload());
  } else {
    Swal.fire("‚ùå Erro", data.error || "Algo deu errado!", "error");
  }
})
.catch(err => {
  Swal.fire("‚ùå Erro", "Falha de conex√£o com o servidor.", "error");
  console.error(err);
});

          }
        });
      });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
